# GEP V1.0 사용자 등록/인증 시스템 설계

## 📋 개요
**General Exam Platform (GEP) V1.0** - 사용자 등록/인증 시스템 설계
**기준**: ACIU S4 검증된 아키텍처 + GEP 요구사항
**목표**: 간단하고 안전한 사용자 관리 시스템

---

## 🎯 핵심 설계 원칙

### **ACIU S4 검증된 패턴 적용**
- **등록 시점 기반 통계**: 모든 통계의 출발점은 사용자 등록일
- **게스트 모드 지원**: 즉시 체험 가능한 진입 장벽 제거
- **데이터 영속성**: LocalStorage 기반 안정적 데이터 보존
- **중앙 아키텍처 연동**: 모든 사용자 데이터는 중앙에서 관리

### **GEP 특화 요구사항**
- **3단계 서비스 레벨**: FREE, PREMIUM, PRO
- **범용 플랫폼**: 다양한 자격시험 지원
- **결제 시스템 연동**: 유료 서비스 업그레이드
- **데이터 마이그레이션**: 기존 GEP_MASTER 데이터 활용

---

## 🔐 사용자 등록 시스템

### **1. 등록 플로우 설계**

#### **시작 화면 플로우**
```
앱 시작 → 사용자 등록 여부 확인 → 분기
    ↓
기존 사용자: 바로 대문 (홈페이지)
신규 사용자: 등록 선택 화면
    ↓
게스트 등록: 기본값으로 즉시 대문
실제 사용자 등록: 정보 입력 후 대문
```

#### **등록 선택 화면 UI**
```html
<!-- 등록 선택 화면 HTML 구조 -->
<div id="registration-choice-screen" class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
        <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">
            GEP 학습 플랫폼
        </h1>
        
        <div class="space-y-4">
            <!-- 게스트 등록 버튼 -->
            <button onclick="registerAsGuest()" 
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                🚀 게스트로 시작하기 (3초)
            </button>
            
            <!-- 실제 사용자 등록 버튼 -->
            <button onclick="showUserRegistration()" 
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                👤 사용자 등록하기
            </button>
        </div>
        
        <p class="text-sm text-gray-600 text-center mt-6">
            언제든지 설정에서 정보를 변경할 수 있습니다
        </p>
    </div>
</div>
```

### **2. 게스트 등록 시스템**

#### **게스트 등록 함수**
```javascript
class GuestRegistrationService {
    // 게스트 사용자 자동 등록
    static registerAsGuest() {
        const guestUser = {
            id: this.generateGuestId(),
            name: '게스트',
            email: null,
            serviceLevel: 'FREE',
            registrationDate: new Date().toISOString(),
            examDate: this.getDefaultExamDate(),
            isGuest: true,
            preferences: {
                examType: 'INSURANCE_BROKER', // 기본값
                targetRound: 28 // 최신 회차
            }
        };
        
        // LocalStorage에 저장
        this.saveUser(guestUser);
        
        // 통계 데이터 초기화
        this.initializeUserStatistics(guestUser.id);
        
        // 세션 생성
        SessionManager.createSession(guestUser.id);
        
        // 홈페이지로 이동
        this.navigateToHome();
        
        return guestUser;
    }
    
    // 게스트 ID 생성
    static generateGuestId() {
        return `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
    
    // 기본 시험일 설정 (6개월 후)
    static getDefaultExamDate() {
        const date = new Date();
        date.setMonth(date.getMonth() + 6);
        return date.toISOString().split('T')[0];
    }
}
```

### **3. 실제 사용자 등록 시스템**

#### **사용자 등록 폼**
```html
<!-- 사용자 등록 폼 HTML -->
<div id="user-registration-form" class="hidden">
    <form onsubmit="registerRealUser(event)" class="space-y-4">
        <div>
            <label class="block text-sm font-medium text-gray-700">이름</label>
            <input type="text" id="userName" required 
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
            <label class="block text-sm font-medium text-gray-700">이메일 (선택)</label>
            <input type="email" id="userEmail" 
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
            <label class="block text-sm font-medium text-gray-700">시험 종류</label>
            <select id="examType" required 
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="INSURANCE_BROKER">보험중개사</option>
                <option value="LOSS_ADJUSTER">보험심사역</option>
            </select>
        </div>
        
        <div>
            <label class="block text-sm font-medium text-gray-700">목표 시험일</label>
            <input type="date" id="examDate" required 
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <button type="submit" 
                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
            등록 완료
        </button>
    </form>
</div>
```

#### **실제 사용자 등록 함수**
```javascript
class UserRegistrationService {
    // 실제 사용자 등록
    static async registerRealUser(userData) {
        try {
            // 입력값 검증
            this.validateUserData(userData);
            
            // 사용자 정보 생성
            const user = {
                id: this.generateUserId(),
                name: userData.name,
                email: userData.email || null,
                serviceLevel: 'FREE', // 기본값
                registrationDate: new Date().toISOString(),
                examDate: userData.examDate,
                examType: userData.examType,
                isGuest: false,
                preferences: {
                    examType: userData.examType,
                    targetRound: this.getLatestRound(userData.examType)
                }
            };
            
            // LocalStorage에 저장
            this.saveUser(user);
            
            // 통계 데이터 초기화
            this.initializeUserStatistics(user.id);
            
            // 세션 생성
            SessionManager.createSession(user.id);
            
            // 홈페이지로 이동
            this.navigateToHome();
            
            return user;
            
        } catch (error) {
            console.error('사용자 등록 실패:', error);
            throw error;
        }
    }
    
    // 입력값 검증
    static validateUserData(userData) {
        if (!userData.name || userData.name.trim().length < 2) {
            throw new Error('이름은 2자 이상 입력해주세요.');
        }
        
        if (userData.email && !this.isValidEmail(userData.email)) {
            throw new Error('올바른 이메일 형식을 입력해주세요.');
        }
        
        if (!userData.examDate) {
            throw new Error('목표 시험일을 선택해주세요.');
        }
        
        const examDate = new Date(userData.examDate);
        const today = new Date();
        if (examDate <= today) {
            throw new Error('목표 시험일은 오늘 이후로 설정해주세요.');
        }
    }
}
```

---

## 🔑 인증 시스템

### **1. 세션 관리**

#### **SessionManager 클래스**
```javascript
class SessionManager {
    // 세션 생성
    static createSession(userId) {
        const session = {
            userId,
            startTime: new Date().toISOString(),
            lastActivity: new Date().toISOString(),
            sessionId: this.generateSessionId()
        };
        
        localStorage.setItem('gep_session', JSON.stringify(session));
        return session;
    }
    
    // 현재 사용자 조회
    static getCurrentUser() {
        const session = localStorage.getItem('gep_session');
        if (!session) return null;
        
        try {
            const sessionData = JSON.parse(session);
            const user = UserService.getUserById(sessionData.userId);
            
            if (!user) {
                this.clearSession();
                return null;
            }
            
            // 세션 갱신
            this.updateLastActivity();
            
            return user;
        } catch (error) {
            console.error('세션 파싱 오류:', error);
            this.clearSession();
            return null;
        }
    }
    
    // 세션 유효성 검사
    static isSessionValid() {
        const user = this.getCurrentUser();
        return user !== null;
    }
    
    // 세션 종료
    static clearSession() {
        localStorage.removeItem('gep_session');
    }
    
    // 마지막 활동 시간 업데이트
    static updateLastActivity() {
        const session = localStorage.getItem('gep_session');
        if (session) {
            const sessionData = JSON.parse(session);
            sessionData.lastActivity = new Date().toISOString();
            localStorage.setItem('gep_session', JSON.stringify(sessionData));
        }
    }
}
```

### **2. 접근 제어**

#### **AccessControl 클래스**
```javascript
class AccessControl {
    // 서비스 레벨별 접근 제어
    static checkServiceLevel(requiredLevel) {
        const user = SessionManager.getCurrentUser();
        if (!user) return false;
        
        const levelHierarchy = {
            'FREE': 1,
            'PREMIUM': 2,
            'PRO': 3
        };
        
        return levelHierarchy[user.serviceLevel] >= levelHierarchy[requiredLevel];
    }
    
    // 기능별 접근 제어
    static checkFeatureAccess(featureName) {
        const featureMatrix = {
            'roundBasedQuestions': ['FREE', 'PREMIUM', 'PRO'],
            'subjectFiltering': ['PREMIUM', 'PRO'],
            'detailedAnalytics': ['PREMIUM', 'PRO'],
            'trueFalseQuestions': ['PRO'],
            'passRatePrediction': ['PRO']
        };
        
        const requiredLevel = featureMatrix[featureName];
        if (!requiredLevel) return false;
        
        return this.checkServiceLevel(requiredLevel[0]);
    }
    
    // 페이지 접근 제어
    static checkPageAccess(pageName) {
        const pageAccess = {
            'home': ['FREE', 'PREMIUM', 'PRO'],
            'statistics': ['FREE', 'PREMIUM', 'PRO'],
            'advancedStatistics': ['PREMIUM', 'PRO'],
            'trueFalseQuestions': ['PRO'],
            'settings': ['FREE', 'PREMIUM', 'PRO']
        };
        
        const requiredLevel = pageAccess[pageName];
        if (!requiredLevel) return false;
        
        return this.checkServiceLevel(requiredLevel[0]);
    }
}
```

---

## 📊 통계 데이터 초기화

### **1. 사용자별 통계 초기화**

#### **StatisticsInitializer 클래스**
```javascript
class StatisticsInitializer {
    // 사용자 등록 시 통계 데이터 초기화
    static initializeUserStatistics(userId) {
        const user = UserService.getUserById(userId);
        if (!user) return;
        
        // 기본 통계 데이터 생성
        const statistics = {
            userId: userId,
            registrationDate: user.registrationDate,
            examDate: user.examDate,
            
            // 기본 진도 데이터
            progress: {
                basicLearning: { currentQuestion: 1, completedQuestions: [] },
                largeCategoryLearning: {
                    '관계법령': { currentQuestion: 1, completedQuestions: [] },
                    '손보1부': { currentQuestion: 1, completedQuestions: [] },
                    '손보2부': { currentQuestion: 1, completedQuestions: [] }
                }
            },
            
            // 기본 통계 데이터
            statistics: {
                totalQuestionsAttempted: 0,
                totalCorrectAnswers: 0,
                accuracyRate: 0,
                studyDays: 0,
                dailyProgress: {},
                categoryStatistics: {}
            },
            
            // 학습 히스토리
            learningHistory: [],
            
            // 설정 데이터
            settings: {
                notifications: true,
                darkMode: false,
                autoSave: true
            }
        };
        
        // LocalStorage에 저장
        localStorage.setItem(`gep_user_${userId}_statistics`, JSON.stringify(statistics));
        
        // 중앙 아키텍처에 등록
        CentralDataManager.registerUser(userId, statistics);
    }
}
```

### **2. D-Day 계산 시스템**

#### **DDayCalculator 클래스**
```javascript
class DDayCalculator {
    // D-Day 계산
    static calculateDDay(examDate) {
        const today = new Date();
        const exam = new Date(examDate);
        
        const diffTime = exam - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        return diffDays;
    }
    
    // 학습 경과일 계산
    static calculateStudyDays(registrationDate) {
        const today = new Date();
        const registration = new Date(registrationDate);
        
        const diffTime = today - registration;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        return Math.max(1, diffDays); // 최소 1일
    }
    
    // 학습 일정 추천
    static getRecommendedStudyPlan(examDate, currentProgress) {
        const dDay = this.calculateDDay(examDate);
        const totalQuestions = 789; // GEP_MASTER 총 문제 수
        const remainingQuestions = totalQuestions - currentProgress;
        
        return {
            dailyQuestions: Math.ceil(remainingQuestions / dDay),
            weeklyGoal: Math.ceil(remainingQuestions / Math.ceil(dDay / 7)),
            estimatedCompletion: Math.ceil(remainingQuestions / 20) // 하루 20문제 기준
        };
    }
}
```

---

## 🔄 데이터 마이그레이션

### **1. 기존 데이터 활용**

#### **DataMigrationService 클래스**
```javascript
class DataMigrationService {
    // 기존 GEP_MASTER 데이터 마이그레이션
    static migrateGepMasterData() {
        try {
            // GEP_MASTER.xlsx 데이터 로드
            const gepMasterData = this.loadGepMasterData();
            
            // 데이터베이스에 저장
            this.saveToDatabase(gepMasterData);
            
            // 캐시 초기화
            QuestionCache.clear();
            
            console.log('GEP_MASTER 데이터 마이그레이션 완료');
            return true;
            
        } catch (error) {
            console.error('데이터 마이그레이션 실패:', error);
            return false;
        }
    }
    
    // 사용자 데이터 백업/복원
    static backupUserData(userId) {
        const userData = {
            user: UserService.getUserById(userId),
            statistics: localStorage.getItem(`gep_user_${userId}_statistics`),
            progress: localStorage.getItem(`gep_user_${userId}_progress`)
        };
        
        const backupData = JSON.stringify(userData);
        localStorage.setItem(`gep_backup_${userId}_${Date.now()}`, backupData);
        
        return backupData;
    }
    
    static restoreUserData(userId, backupData) {
        try {
            const data = JSON.parse(backupData);
            
            // 사용자 정보 복원
            UserService.saveUser(data.user);
            
            // 통계 데이터 복원
            localStorage.setItem(`gep_user_${userId}_statistics`, data.statistics);
            
            // 진도 데이터 복원
            localStorage.setItem(`gep_user_${userId}_progress`, data.progress);
            
            return true;
            
        } catch (error) {
            console.error('데이터 복원 실패:', error);
            return false;
        }
    }
}
```

---

## 🧪 테스트 시나리오

### **1. 등록 시나리오 테스트**
```javascript
describe('User Registration Tests', () => {
    test('게스트 등록 성공', () => {
        const guest = GuestRegistrationService.registerAsGuest();
        expect(guest.isGuest).toBe(true);
        expect(guest.serviceLevel).toBe('FREE');
        expect(SessionManager.isSessionValid()).toBe(true);
    });
    
    test('실제 사용자 등록 성공', () => {
        const userData = {
            name: '홍길동',
            email: 'hong@test.com',
            examType: 'INSURANCE_BROKER',
            examDate: '2025-06-15'
        };
        
        const user = UserRegistrationService.registerRealUser(userData);
        expect(user.isGuest).toBe(false);
        expect(user.name).toBe('홍길동');
        expect(user.serviceLevel).toBe('FREE');
    });
    
    test('입력값 검증 실패', () => {
        const invalidData = {
            name: 'A', // 너무 짧음
            examDate: '2024-01-01' // 과거 날짜
        };
        
        expect(() => {
            UserRegistrationService.registerRealUser(invalidData);
        }).toThrow();
    });
});
```

### **2. 인증 시나리오 테스트**
```javascript
describe('Authentication Tests', () => {
    test('세션 유효성 검사', () => {
        // 세션 생성
        SessionManager.createSession('test_user');
        expect(SessionManager.isSessionValid()).toBe(true);
        
        // 세션 종료
        SessionManager.clearSession();
        expect(SessionManager.isSessionValid()).toBe(false);
    });
    
    test('접근 제어 검사', () => {
        // FREE 사용자 테스트
        const freeUser = { serviceLevel: 'FREE' };
        expect(AccessControl.checkServiceLevel('FREE')).toBe(true);
        expect(AccessControl.checkServiceLevel('PREMIUM')).toBe(false);
        
        // PRO 사용자 테스트
        const proUser = { serviceLevel: 'PRO' };
        expect(AccessControl.checkServiceLevel('FREE')).toBe(true);
        expect(AccessControl.checkServiceLevel('PRO')).toBe(true);
    });
});
```

---

## 🎯 구현 우선순위

### **Phase 1: 기본 등록 시스템 (2주)**
1. **게스트 등록**: 즉시 시작 가능한 시스템
2. **실제 사용자 등록**: 기본 정보 입력 시스템
3. **세션 관리**: 간단한 인증 시스템

### **Phase 2: 고급 기능 (2주)**
1. **접근 제어**: 서비스 레벨별 기능 제한
2. **데이터 마이그레이션**: 기존 데이터 활용
3. **백업/복원**: 사용자 데이터 보호

### **Phase 3: 최적화 (1주)**
1. **성능 최적화**: 빠른 로딩 및 응답
2. **보안 강화**: 데이터 암호화 및 보호
3. **테스트 완성**: 안정성 보장

---

**작성자**: AI Assistant (Seo Daeri)  
**작성일**: 2024-12-19  
**기준**: ACIU S4 검증된 아키텍처 + GEP 요구사항
